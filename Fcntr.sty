\NeedsTeXFormat{pLaTeX2e}
\ProvidesPackage{Fcntr}
\PackageInfo{Fcntr}{availabel global options: \MessageBreak
[nobox]}

\usepackage{enumitem_extended}
\usepackage{fancybox}

\newtoks\fstyle@current
\newtoks\fstyle@temp
\newcounter{Fcntr}
\newcounter{fref}
\newcounter{ffref}
\newcounter{Fcntr@}
\newif\ifnobox
\newif\iffst@red

\noboxfalse
\DeclareOption{nobox}{\noboxtrue}
\ProcessOptions\relax
\setcounter{Fcntr}{0}
\@addtoreset{Fcntr}{section}

\newcommand\fstyle{\@ifstar{\@@fstyle}{\@fstyle}}

\newcommand\@fstyle[1]{\fstyle@current{#1}
  \global\fst@redfalse
  \gdef\Fcntr@@@fstyle{\csname #1\endcsname{Fcntr}}%
  \gdef\fref@@@fstyle{\csname #1\endcsname{fref}}}

\def\thr@@st@r#1*#2*#3*{#1{#3}#2}

\newcommand\@@fstyle[1]{\fstyle@current{#1}
  \global\fst@redtrue
  \gdef\Fcntr@@@fstyle{\expandafter\thr@@st@r\relax#1\relax*Fcntr*}%
  \gdef\fref@@@fstyle{\expandafter\thr@@st@r\relax#1\relax*fref*}}

\newcommand\f{\@ifstar{\@@f}{\@f}}

\newcommand\@f[1]{
  \if#1{}\def\ARG{{#1}}\else\def\ARG{#1}\fi
  \ifnobox
    \if\ARG　{#1}
    \else
      \if\ARG""\addtocounter{Fcntr}{1}{\Fcntr@@@fstyle}
      \else\setcounter{fref}{#1}{\fref@@@fstyle}
      \fi
    \fi
  \else
    \if\ARG　\framebox[1.2cm]{#1}
    \else
      \if\ARG""\ifmmode\mathop{\addtocounter{Fcntr}{1}\framebox[1.2cm]{\Fcntr@@@fstyle}}\else
      \addtocounter{Fcntr}{1}\framebox[1.2cm]{\Fcntr@@@fstyle}
      \fi\else\ifmmode\mathop{\setcounter{fref}{#1}\framebox[1.2cm]{\fref@@@fstyle}}\else
      \setcounter{fref}{#1}\framebox[1.2cm]{\fref@@@fstyle}
      \fi\fi
    \fi
  \fi}

\newcommand\@@f[1]{%
  \if#1{}\def\ARG{{#1}}\else\def\ARG{#1}\fi
  \if\ARG　{#1}
  \else
    \if\ARG""\addtocounter{Fcntr}{1}{\Fcntr@@@fstyle}%
    \else\setcounter{fref}{#1}{\fref@@@fstyle}%
    \fi
  \fi}

\newcommand\ff[1]{
  \if#1{}\def\ARG{{#1}}\else\def\ARG{#1}\fi
  \if\ARG　\doublebox{\hspace{.7zw}　\hspace{.7zw}}
  \else\setcounter{ffref}{#1}\ifmmode\mathop{\doublebox{\hspace{.7zw}\csname\the\fstyle\endcsname{ffref}\hspace{.7zw}}}\else
  \doublebox{\hspace{.7zw}\csname\the\fstyle\endcsname{ffref}\hspace{.7zw}}
  \fi\fi}

\newcommand\fnest{\@ifstar{\@@fnest}{\@fnest}}

\newcommand\@fnest[1]{\fstyle@temp\fstyle@current
  \gdef\Fcntr@@@fstyle{\csname #1\endcsname{Fcntr}}%
  \gdef\fref@@@fstyle{\csname #1\endcsname{fref}}%
  \setcounter{Fcntr@}{\theFcntr}%
  \setcounter{Fcntr}{0}}

\newcommand\@@fnest[1]{\fstyle@temp\fstyle@current
  \gdef\Fcntr@@@fstyle{\expandafter\thr@@st@r\relax#1\relax*Fcntr*}%
  \gdef\fref@@@fstyle{\expandafter\thr@@st@r\relax#1\relax*fref*}%
  \setcounter{Fcntr@}{\theFcntr}%
  \setcounter{Fcntr}{0}}

\newcommand\funnest{\fstyle@current\fstyle@temp
  \iffst@red\edef\f@rg@Fcntr{\relax\the\fstyle@temp\relax*Fcntr*}
    \edef\f@rg@fref{\relax\the\fstyle@temp\relax*fref*}
    \gdef\Fcntr@@@fstyle{\expandafter\thr@@st@r\f@rg@Fcntr}%
    \gdef\fref@@@fstyle{\expandafter\thr@@st@r\f@rg@fref}
  \else\expandafter\fstyle{\the\fstyle@temp}\fi
  \setcounter{Fcntr}{\theFcntr@}}
