\NeedsTeXFormat{pLaTeX2e}
\ProvidesPackage{circle_eqnumber}[2019/4/27 created by Hogemura. Visit https://github.com/tetsu-osaka-physics/tetsu_physic for further help!]

%%%%%%%%%%%パッケージ奴%%%%%%%%%%%

\usepackage{amsmath,enumitem_extended}
\usepackage[bold]{otf}
\usepackage[dvipdfmx]{color}

%%%%%%%%%%%式キャプションを丸数字にする奴%%%%%%%%%%%

% \newcounter{ceq}
% \DeclareRobustCommand*{\eqmaru}[1]{%
%   \refstepcounter{ceq}%
%   \ajMaru{\arabic{ceq}}%
%   \label{#1}}
% \makeatletter

\def\eqref#1{%
  \expandafter\ifx\csname r@#1\endcsname\relax
    \ref{#1}
  \else
    \protected@edef\@maruref@temp{
      \expandafter\expandafter\expandafter
      \@firstoftwo\csname r@#1\endcsname\empty\empty}%
  %      \protected@edef\@maruref@temp{%
  %        \expandafter\expandafter\expandafter
  %        \@car\csname r@#1\endcsname\empty\@nil}%
    \ajMaru{\@maruref@temp}%
  \fi}
\makeatother

\makeatletter
\newif\iflongequation
\renewenvironment{align}{
\settowidth{\@FWdim}{　}
\let\xatlevel@\@ne
\maxfields@\m@ne\relax
  $$%
  \let\split\insplit@
  \DN@{\align@\st@rredfalse}
  \collect@body\next@
  \checkat@false
}{%
  \math@cr
  \noalign{
      \ifdim\totwidth@>\displaywidth
          \dimen@\prevdepth
          \nointerlineskip
          \vskip-\ht\strutbox@
          \vskip-\dp\strutbox@
          \vbox{\noindent\hbox to\displaywidth{\hbox to\totwidth@{\strut@\hfill}}}%
          \prevdepth\dimen@
          \longequationtrue
          \colorbox{black}{\textcolor{white}{式長い！}}
      \fi
  }
  \egroup
  $$
  \ignorespacesafterend
}

\def\place@tag{%
    \iftagsleft@
        \kern-\tagshift@
        \if1\shift@tag\row@\relax
            \rlap{\vbox{%
                \normalbaselines
                \boxz@
                \vbox to\lineht@{}%
                \raise@tag
            }}%
        \else
            \rlap{\boxz@}%
        \fi
        \kern\displaywidth@
    \else
        \iflongequation
          \kern-\tagshift@
        \else
          \qquad\qquad
        \fi
        \if1\shift@tag\row@\relax
            \llap{\vtop{%
                \raise@tag
                \normalbaselines
                \setbox\@ne\null
                \dp\@ne\lineht@
                \box\@ne
                \boxz@
            }}%
        \else
            \llap{\boxz@}%
        \fi
    \fi
}
\makeatother

\makeatletter
\newdimen\@tagdim
\def\tagform@#1{\if@eqnsw%
… \maketag@@@{\ajMaru{#1}} % 9.24683pt
\else \settowidth{\@tagdim}{#1}
\advance\@tagdim by-9.24683pt
\multiply\@tagdim by-1%
… \maketag@@@{#1\hspace{\the\@tagdim}}
\fi}
\makeatother
